<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>{% block title %}Helpy - Get Advice from People Who Can Help{% endblock %}</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- ‚úÖ CSS Globale -->
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/mobile.css">
    
    <!-- CSS specifici per pagina -->
    {% block extra_css %}{% endblock %}
    
    <style>
        /* üé® Stili Header Globali */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 48px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        
        /* Left: Solo Logo + Helpy */
        .navbar-left {
            display: flex;
            align-items: center;
        }
        
        .navbar-logo-link {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }
        
        .navbar-logo {
            height: 40px;
            width: auto;
        }
        
        .navbar-title {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Right: Link semplici in riga */
        .navbar-links {
            display: flex;
            align-items: center;
            gap: 24px;
        }
        
        .navbar-link {
            color: #333;
            font-weight: 500;
            font-size: 16px;
            text-decoration: none;
            padding: 8px 16px;
            transition: color 0.3s ease;
            white-space: nowrap;
        }
        
        .navbar-link:hover {
            color: #667eea;
        }
        
        /* Bottone registrazione con gradient */
        .register-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 24px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 16px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .register-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }
        
        .logout-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }
        
        .logout-btn:hover {
            box-shadow: 0 6px 16px rgba(231, 76, 60, 0.4);
        }
        
        /* === NOTIFICHE === */
        .notifications-icon {
            position: relative;
            cursor: pointer;
            font-size: 15px;
            color: white;
            padding: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            margin-left: 12px;
            margin-bottom: 4px;
        }
        
        .notifications-icon:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
        }
        
        .chat-reopen-text {
            position: absolute;
            bottom: -16px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 9px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            padding: 2px 7px;
            border-radius: 6px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s ease;
            box-shadow: 0 2px 6px rgba(52, 152, 219, 0.3);
        }
        
        .chat-reopen-text:hover {
            background: linear-gradient(135deg, #2980b9 0%, #3498db 100%);
            transform: translateX(-50%) translateY(-1px);
            box-shadow: 0 3px 8px rgba(52, 152, 219, 0.4);
        }
        
        .notifications-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: #e74c3c;
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }
        
        .notifications-dropdown {
            position: absolute;
            top: 70px;
            right: 20px;
            width: 400px;
            max-height: 600px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            display: none;
            flex-direction: column;
            z-index: 1000;
            overflow: hidden;
        }
        
        .notifications-dropdown.show {
            display: flex;
        }
        
        .notifications-header {
            padding: 16px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .notifications-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }
        
        .mark-all-read-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: background 0.3s ease;
        }
        
        .mark-all-read-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .notifications-list {
            flex: 1;
            overflow-y: auto;
            max-height: 500px;
        }
        
        .notification-item {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }
        
        .notification-item:hover {
            background: #f8f9ff;
        }
        
        .notification-item.unread {
            background: #f8f9ff;
        }
        
        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .notification-icon.booking {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-title {
            font-weight: 600;
            font-size: 14px;
            color: #333;
            margin-bottom: 4px;
        }
        
        .notification-message {
            font-size: 13px;
            color: #666;
            margin-bottom: 4px;
        }
        
        .notification-time {
            font-size: 12px;
            color: #999;
        }
        
        .notifications-empty {
            padding: 40px 20px;
            text-align: center;
            color: #999;
        }
        
        .notifications-empty i {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.3;
        }
        
        /* Animazione campanella */
        @keyframes bellRing {
            0%, 100% { transform: rotate(0deg); }
            10%, 30% { transform: rotate(-15deg); }
            20%, 40% { transform: rotate(15deg); }
            50% { transform: rotate(0deg); }
        }
        
        /* === DROPDOWN CATEGORIE === */
        .navbar-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .navbar-dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            min-width: 280px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            border-radius: 12px;
            padding: 12px 0;
            margin-top: 8px;
            z-index: 1000;
            animation: dropdownSlide 0.3s ease;
        }
        
        @keyframes dropdownSlide {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .navbar-dropdown:hover .navbar-dropdown-content {
            display: block;
        }
        
        .dropdown-category-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: #333;
            text-decoration: none;
            transition: all 0.2s ease;
        }
        
        .dropdown-category-item:hover {
            background: linear-gradient(90deg, #f8f9ff 0%, #ffffff 100%);
            color: #667eea;
        }
        
        .dropdown-category-icon {
            font-size: 24px;
            width: 32px;
            text-align: center;
        }
        
        .dropdown-category-info {
            flex: 1;
        }
        
        .dropdown-category-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }
        
        .dropdown-category-desc {
            font-size: 12px;
            color: #666;
        }
        
        .dropdown-divider {
            height: 1px;
            background: #e0e0e0;
            margin: 8px 16px;
        }
        
        .dropdown-all-link {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .dropdown-all-link:hover {
            background: #f8f9ff;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .navbar {
                padding: 12px 20px;
            }
            
            .navbar-title {
                font-size: 22px;
            }
            
            .navbar-links {
                gap: 12px;
            }
            
            .navbar-link,
            .register-btn {
                font-size: 14px;
                padding: 8px 16px;
            }
            
            /* Nasconde testo "Trova Consulenti" su mobile, lascia solo icona */
            .navbar-link-text {
                display: none;
            }
        }
        
        /* üé® Stili Footer Globali */
        .footer {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            padding: 64px 48px 32px;
            margin-top: 80px;
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 48px;
            margin-bottom: 32px;
        }
        
        .footer-section h3 {
            margin: 0 0 16px;
            font-size: 20px;
            color: #667eea;
        }
        
        .footer-section ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .footer-section li {
            margin-bottom: 12px;
        }
        
        .footer-section a {
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: color 0.3s ease;
        }
        
        .footer-section a:hover {
            color: #667eea;
        }
        
        .footer-bottom {
            text-align: center;
            padding-top: 32px;
            border-top: 1px solid rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.6);
            font-size: 14px;
        }
        
        /* Spazio per navbar fissa */
        body {
            padding-top: 80px;
        }
    </style>
</head>
<body>

    <!-- üéØ HEADER GLOBALE -->
    <nav class="navbar">
        <!-- Left: Solo Logo + Helpy -->
        <div class="navbar-left">
            <a href="/" class="navbar-logo-link">
                <img src="https://i.imgur.com/4M34hi2.png" alt="Helpy Logo" class="navbar-logo">
                <span class="navbar-title">Helpy</span>
            </a>
        </div>
        
        <!-- Right: Link semplici in fila -->
        <div class="navbar-links">
            <!-- Trova Consulenti con Dropdown -->
            <div class="navbar-dropdown">
                <a href="/consultants" class="navbar-link">
                    <span class="navbar-link-text">Trova Consulenti</span>
                    <i class="fas fa-chevron-down" style="font-size: 12px; margin-left: 4px;"></i>
                </a>
                
                <!-- Dropdown Content -->
                <div class="navbar-dropdown-content">
                    {% if categories %}
                        {% for category in categories %}
                        <a href="/consultants?category={{ category.id }}" class="dropdown-category-item">
                            <span class="dropdown-category-icon">{{ category.icon }}</span>
                            <div class="dropdown-category-info">
                                <div class="dropdown-category-name">{{ category.name }}</div>
                                {% if category.description %}
                                <div class="dropdown-category-desc">{{ category.description[:50] }}...</div>
                                {% endif %}
                            </div>
                        </a>
                        {% endfor %}
                        
                        <div class="dropdown-divider"></div>
                        
                        <a href="/consultants" class="dropdown-all-link">
                            <i class="fas fa-th"></i>
                            <span>Vedi Tutti i Consulenti</span>
                        </a>
                    {% else %}
                        <a href="/consultants" class="dropdown-all-link">
                            <span>Vedi Tutti i Consulenti</span>
                        </a>
                    {% endif %}
                </div>
            </div>
            
            <!-- Nuovo link alla Community -->
            <a href="/community" class="navbar-link">
                <span class="navbar-link-text">Community</span>
            </a>
            
            {% if current_user %}
                <!-- Profilo Utente -->
                <a href="/profile" class="navbar-link">
                    <span style="font-size: 18px;">üë§</span>
                    <span class="navbar-link-text">{{ current_user.nome or current_user.email.split('@')[0] }}</span>
                </a>
                
                <!-- Logout -->
                <a href="/logout" class="register-btn logout-btn">
                    Logout
                </a>
                
                <!-- Icona Notifiche con testo Chat sotto -->
                <div class="notifications-icon" id="notificationsIcon" onclick="toggleNotifications()">
                    <i class="fas fa-bell"></i>
                    <span class="notifications-badge" id="notificationsBadge" style="display: none;">0</span>
                    <span class="chat-reopen-text" onclick="event.stopPropagation(); reopenChatWidget()">Chat</span>
                </div>
            {% else %}
                <!-- Accedi -->
                <a href="/login" class="navbar-link">Accedi</a>
                
                <!-- Registrati -->
                <a href="/register" class="register-btn">
                    Registrati Gratis
                </a>
            {% endif %}
        </div>
    </nav>

    <!-- Dropdown Notifiche -->
    <div class="notifications-dropdown" id="notificationsDropdown">
        <div class="notifications-header">
            <h3><i class="fas fa-bell"></i> Notifiche</h3>
            <button class="mark-all-read-btn" onclick="markAllAsRead()">
                <i class="fas fa-check-double"></i> Segna tutte lette
            </button>
        </div>
        <div class="notifications-list" id="notificationsList">
            <div class="notifications-empty">
                <i class="fas fa-bell-slash"></i>
                <p>Nessuna notifica</p>
            </div>
        </div>
    </div>

    <!-- üéØ CONTENUTO PAGINA (da sovrascrivere) -->
    {% block content %}{% endblock %}

    <!-- üéØ FOOTER GLOBALE -->
    <footer class="footer">
        <div class="footer-content">
            <!-- Sezione About -->
            <div class="footer-section">
                <h3>ü¶ä Helpy</h3>
                <p style="color: rgba(255,255,255,0.7); line-height: 1.6;">
                    La piattaforma che connette persone in cerca di aiuto con esperti che hanno gi√† affrontato le stesse sfide.
                </p>
            </div>
            
            <!-- Sezione Link Utili -->
            <div class="footer-section">
                <h3>Link Utili</h3>
                <ul>
                    <li><a href="/">Home</a></li>
                    <li><a href="/consultants">Trova Consulenti</a></li>
                    <li><a href="/register">Diventa Consulente</a></li>
                    <li><a href="/about">Chi Siamo</a></li>
                </ul>
            </div>
            
            <!-- Sezione Supporto -->
            <div class="footer-section">
                <h3>Supporto</h3>
                <ul>
                    <li><a href="/faq">FAQ</a></li>
                    <li><a href="/contact">Contattaci</a></li>
                    <li><a href="/privacy">Privacy Policy</a></li>
                    <li><a href="/terms">Termini di Servizio</a></li>
                </ul>
            </div>
            
            <!-- Sezione Social -->
            <div class="footer-section">
                <h3>Seguici</h3>
                <ul>
                    <li><a href="#" style="display: flex; align-items: center; gap: 8px;">
                        <span>üìò</span> Facebook
                    </a></li>
                    <li><a href="#" style="display: flex; align-items: center; gap: 8px;">
                        <span>üê¶</span> Twitter
                    </a></li>
                    <li><a href="#" style="display: flex; align-items: center; gap: 8px;">
                        <span>üì∑</span> Instagram
                    </a></li>
                    <li><a href="#" style="display: flex; align-items: center; gap: 8px;">
                        <span>üíº</span> LinkedIn
                    </a></li>
                </ul>
            </div>
        </div>
        
        <div class="footer-bottom">
            ¬© {{ current_year or 2025 }} Helpy. Tutti i diritti riservati. Made with ‚ù§Ô∏è in Italy
        </div>
    </footer>

    <!-- Chat Widget (incluso globalmente) -->
    {% if user %}
        {% include "chat_widget.html" %}
    {% endif %}

    <!-- JavaScript Globale -->
    <script src="/static/script.js"></script>
    
    <!-- JavaScript Notifiche -->
    <script>
        let notificationsInterval;
        let lastNotificationCount = 0;
        
        // Toggle dropdown notifiche
        function toggleNotifications() {
            const dropdown = document.getElementById('notificationsDropdown');
            const isVisible = dropdown.classList.contains('show');
            
            if (isVisible) {
                dropdown.classList.remove('show');
            } else {
                dropdown.classList.add('show');
                loadNotifications();
            }
        }
        
        // Riapri il widget della chat
        function reopenChatWidget() {
            console.log('üîÑ Riapertura widget chat...');
            
            // Controlla se il widget esiste
            const chatWidget = document.getElementById('chatWidget');
            if (!chatWidget) {
                console.warn('‚ö†Ô∏è Widget chat non trovato');
                return;
            }
            
            // Mostra il widget
            chatWidget.style.display = 'block';
            
            // Nascondi il bottone e apri la finestra
            const chatButton = document.getElementById('chatButton');
            const chatWindow = document.getElementById('chatWindow');
            
            if (chatButton) chatButton.style.display = 'none';
            if (chatWindow) {
                chatWindow.classList.add('open');
                if (typeof window.chatWidget !== 'undefined') {
                    window.chatWidget.isOpen = true;
                }
            }
            
            // Mostra la lista delle conversazioni
            if (typeof showConversationsList === 'function') {
                showConversationsList();
            }
            
            console.log('‚úÖ Widget chat riaperto');
        }
        
        // Chiudi dropdown cliccando fuori
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('notificationsDropdown');
            const icon = document.getElementById('notificationsIcon');
            
            if (!dropdown.contains(e.target) && !icon.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });
        
        // Carica notifiche
        async function loadNotifications() {
            try {
                const response = await fetch('/api/notifications?limit=20');
                if (!response.ok) return;
                
                const notifications = await response.json();
                displayNotifications(notifications);
            } catch (error) {
                console.error('Errore caricamento notifiche:', error);
            }
        }
        
        // Mostra notifiche
        function displayNotifications(notifications) {
            const list = document.getElementById('notificationsList');
            
            if (notifications.length === 0) {
                list.innerHTML = `
                    <div class="notifications-empty">
                        <i class="fas fa-bell-slash"></i>
                        <p>Nessuna notifica</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = notifications.map(notif => {
                const timeAgo = getTimeAgo(new Date(notif.created_at));
                const unreadClass = notif.is_read ? '' : 'unread';
                const icon = getNotificationIcon(notif.type);
                
                // Prepara dati utente correlato (escapati per sicurezza)
                const relatedUserId = notif.related_user ? notif.related_user.id : null;
                const relatedUserName = notif.related_user 
                    ? `${notif.related_user.nome} ${notif.related_user.cognome}`.replace(/"/g, '&quot;').replace(/'/g, '&#39;')
                    : '';
                const relatedUserAvatar = notif.related_user ? (notif.related_user.profile_picture || '') : '';
                
                return `
                    <div class="notification-item ${unreadClass}" 
                         data-notification-id="${notif.id}"
                         data-action-url="${notif.action_url || '#'}"
                         data-type="${notif.type}"
                         data-user-id="${relatedUserId || ''}"
                         data-user-name="${relatedUserName}"
                         data-user-avatar="${relatedUserAvatar}"
                         onclick="handleNotificationClick(this)">
                        <div class="notification-icon ${notif.type}">
                            <i class="fas ${icon}"></i>
                        </div>
                        <div class="notification-content">
                            <div class="notification-title">${notif.title}</div>
                            <div class="notification-message">${notif.message}</div>
                            <div class="notification-time">${timeAgo}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Icona per tipo notifica
        function getNotificationIcon(type) {
            const icons = {
                'booking': 'fa-calendar-check',
                'message': 'fa-envelope',
                'payment': 'fa-credit-card',
                'cancellation': 'fa-times-circle',
                'offer': 'fa-handshake'
            };
            return icons[type] || 'fa-bell';
        }
        
        // Calcola tempo trascorso
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'Ora';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' min fa';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' ore fa';
            if (seconds < 604800) return Math.floor(seconds / 86400) + ' giorni fa';
            
            return date.toLocaleDateString('it-IT');
        }
        
        // Gestisce il click su una notifica
        function handleNotificationClick(element) {
            const notificationId = parseInt(element.dataset.notificationId);
            const actionUrl = element.dataset.actionUrl;
            const notificationType = element.dataset.type;
            const relatedUserId = element.dataset.userId ? parseInt(element.dataset.userId) : null;
            const relatedUserName = element.dataset.userName;
            const relatedUserAvatar = element.dataset.userAvatar;
            
            console.log('üîî Click notifica:', {
                id: notificationId,
                type: notificationType,
                userId: relatedUserId,
                userName: relatedUserName,
                avatar: relatedUserAvatar
            });
            
            markAsRead(notificationId, actionUrl, notificationType, relatedUserId, relatedUserName, relatedUserAvatar);
        }
        
        // Segna notifica come letta
        async function markAsRead(notificationId, actionUrl, notificationType, relatedUserId, relatedUserName, relatedUserAvatar) {
            try {
                await fetch(`/api/notifications/${notificationId}/read`, {
                    method: 'POST'
                });
                
                updateUnreadCount();
                loadNotifications();
                
                // Se √® una notifica di messaggio e c'√® un utente correlato, apri il widget chat
                if (notificationType === 'community_contact' && relatedUserId && relatedUserId !== 'null') {
                    // Chiudi il dropdown delle notifiche
                    document.getElementById('notificationsDropdown').classList.remove('active');
                    
                    // Apri il widget chat con l'utente specifico
                    if (typeof window.openChat === 'function') {
                        console.log('üîî Apertura chat da notifica:', { 
                            userId: relatedUserId, 
                            userName: relatedUserName,
                            avatar: relatedUserAvatar
                        });
                        window.openChat(relatedUserId, relatedUserName, relatedUserAvatar || null);
                    } else {
                        // Fallback: vai alla pagina messaggi
                        console.warn('‚ö†Ô∏è window.openChat non trovata, redirect a /messages');
                        window.location.href = actionUrl || '/messages';
                    }
                } else if (actionUrl && actionUrl !== '#') {
                    // Per altre notifiche, usa il redirect normale
                    window.location.href = actionUrl;
                }
            } catch (error) {
                console.error('Errore:', error);
            }
        }
        
        // Segna tutte come lette
        async function markAllAsRead() {
            try {
                await fetch('/api/notifications/read-all', {
                    method: 'POST'
                });
                
                loadNotifications();
                updateUnreadCount();
            } catch (error) {
                console.error('Errore:', error);
            }
        }
        
        // Aggiorna contatore e controlla nuove notifiche
        async function updateUnreadCount() {
            try {
                const response = await fetch('/api/notifications/unread/count');
                if (!response.ok) return;
                
                const data = await response.json();
                const badge = document.getElementById('notificationsBadge');
                
                // Se ci sono nuove notifiche, mostra animazione
                if (data.count > lastNotificationCount && lastNotificationCount > 0) {
                    showNewNotificationAnimation();
                }
                lastNotificationCount = data.count;
                
                if (data.count > 0) {
                    badge.textContent = data.count > 99 ? '99+' : data.count;
                    badge.style.display = 'block';
                } else {
                    badge.style.display = 'none';
                }
                
                // Se il dropdown √® aperto, aggiorna anche le notifiche
                const dropdown = document.getElementById('notificationsDropdown');
                if (dropdown.classList.contains('show')) {
                    loadNotifications();
                }
            } catch (error) {
                console.error('Errore conteggio notifiche:', error);
            }
        }
        
        // Animazione per nuova notifica
        function showNewNotificationAnimation() {
            const icon = document.getElementById('notificationsIcon');
            icon.style.animation = 'none';
            setTimeout(() => {
                icon.style.animation = 'bellRing 0.5s ease-in-out';
            }, 10);
        }
        
        // Polling notifiche (ogni 10 secondi)
        {% if current_user %}
        updateUnreadCount();
        notificationsInterval = setInterval(updateUnreadCount, 10000);
        {% endif %}
    </script>
    
    <!-- JavaScript Specifici per Pagina -->
    {% block extra_js %}{% endblock %}

</body>
</html>