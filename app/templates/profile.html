{% extends "base.html" %}

{% block title %}Profilo - Helpy{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/profile.css">
<!-- Cropper.js Library -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
<style>
    .modal {
        position: fixed !important;
        z-index: 999999 !important;
        left: 0 !important;
        top: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background-color: rgba(0, 0, 0, 0.9) !important;
        display: none !important;
    }
    
    .modal[style*="display: flex"],
    .modal[style*="display:flex"] {
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }
    
    .modal-content {
        background: white !important;
        padding: 40px !important;
        border-radius: 16px !important;
        max-width: 700px !important;
        width: 90% !important;
        position: relative !important;
        z-index: 1000000 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="profile-container">
    <main class="main-content">
        <!-- Upcoming Appointments / Cover Image -->
        <div id="upcomingAppointmentsSection">
            <div class="cover-image" id="coverImagePlaceholder"></div>
        </div>
        
        <!-- Profile Header -->
        <header class="profile-header card">
            <div class="profile-avatar-container">
                {% if user.profile_picture %}
                <img src="{{ user.profile_picture }}" alt="Profile" class="profile-avatar-large" id="profileImage">
                {% else %}
                <div class="profile-avatar-large" id="profileImage">üë§</div>
                {% endif %}
                
                <!-- üî• Bottone per modificare immagine (matita) -->
                <label for="profilePictureInput" class="edit-avatar-btn" title="Cambia immagine profilo">
                    ‚úèÔ∏è
                </label>
                <input type="file" id="profilePictureInput" accept="image/*" style="display: none;">
            </div>
            
            <div class="info">
                <h1>{{ user.nome or 'Nome non impostato' }}</h1>
                <p>{{ user.professione or 'Professione non impostata' }}</p>
                <small style="color: #888;">{{ user.email }}</small>
                <button id="editProfileBtn" class="btn-edit">‚úèÔ∏è Modifica Profilo</button>
            </div>
        </header>

        <!-- Edit Mode Form (Hidden by default) -->
        <section class="card" id="editSection" style="display:none;">
            <h2>Modifica Profilo</h2>
            <div id="successMessage" class="success-message" style="display:none;"></div>
            <div id="errorMessage" class="error-message" style="display:none;"></div>
            
            <form id="profileForm" class="profile-form">
                <div class="form-group">
                    <label>Nome</label>
                    <input type="text" name="nome" value="{{ user.nome or '' }}" placeholder="Inserisci il tuo nome">
                </div>
                
                <div class="form-group">
                    <label>Professione</label>
                    <input type="text" name="professione" value="{{ user.professione or '' }}" placeholder="Es: Lead Software Developer">
                </div>

                <div class="form-group">
                    <label>Categoria</label>
                    <select name="category_id" style="padding:12px; border:1px solid #ddd; border-radius:6px; font-size:1rem;">
                        <option value="">Nessuna categoria</option>
                        {% for cat in categories %}
                        <option value="{{ cat.id }}" {% if user.category_id == cat.id %}selected{% endif %}>
                            {{ cat.icon }} {{ cat.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <small style="color:#888; margin-top:4px; display:block;">Seleziona la categoria che meglio rappresenta la tua expertise</small>
                </div>
                
                <div class="form-group">
                    <label>Descrizione <span id="charCounter" style="float:right; font-size:0.9rem; color:#dc3545;">0/200 caratteri</span></label>
                    <textarea 
                        id="descrizioneTextarea"
                        name="descrizione" 
                        rows="5" 
                        placeholder="Raccontaci di te, della tua esperienza e come puoi aiutare gli altri (minimo 200 caratteri)"
                    >{{ user.descrizione or '' }}</textarea>
                    <small id="descrizioneHint" style="color:#dc3545; display:block; margin-top:4px;">La descrizione deve essere di almeno 200 caratteri per richiedere la verifica del profilo.</small>
                </div>
                
                <div class="form-group">
                    <label>Aree di Interesse</label>
                    <textarea name="aree_interesse" rows="4" placeholder="Es: Sviluppo Mobile, Leadership, Crescita Personale">{{ user.aree_interesse or '' }}</textarea>
                    <small>Separa con virgole</small>
                </div>

                <div class="form-group">
                    <label>Prezzo Consulenza (‚Ç¨)</label>
                    <input type="number" name="prezzo_consulenza" value="{{ user.prezzo_consulenza or 150 }}" min="0" step="10">
                </div>

                <div class="form-group">
                    <label>Durata Consulenza (minuti)</label>
                    <input type="number" name="durata_consulenza" value="{{ user.durata_consulenza or 60 }}" min="15" step="15">
                </div>
                
                <!-- üîí Modalit√† Anonima -->
                <div class="form-group" style="border-top: 1px solid #eee; padding-top: 20px; margin-top: 20px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" name="is_anonymous" value="true" {% if user.is_anonymous %}checked{% endif %} 
                               style="margin-right: 10px; width: 20px; height: 20px;">
                        <span>
                            <strong>üîí Modalit√† Anonima</strong><br>
                            <small style="color: #666;">Se attivata, il tuo nome e cognome non verranno mostrati pubblicamente. Apparir√† "Utente #{{ user.id }}" al posto del tuo nome reale.</small>
                        </span>
                    </label>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Salva Modifiche</button>
                    <button type="button" id="cancelEditBtn" class="btn btn-secondary">Annulla</button>
                </div>
            </form>
        </section>

        <!-- Category Badge (se presente) -->
        {% if user_category %}
        <section class="card" id="viewSection">
            <h2>Categoria</h2>
            <div class="category-badge" style="background:{{ user_category.color }}20; border-left:4px solid {{ user_category.color }}; padding:16px; border-radius:8px;">
                <div style="font-size:2em; margin-bottom:8px;">{{ user_category.icon }}</div>
                <h3 style="margin:0 0 8px 0; color:{{ user_category.color }};">{{ user_category.name }}</h3>
                <p style="margin:0; color:#666;">{{ user_category.description }}</p>
            </div>
        </section>
        {% endif %}

        <!-- Description Section -->
        <section class="card">
            <h2>Descrizione</h2>
            {% if user.descrizione %}
            <p style="white-space: pre-wrap;">{{ user.descrizione }}</p>
            {% else %}
            <p style="color:#888;">Aggiungi una descrizione al tuo profilo per far sapere agli altri chi sei!</p>
            {% endif %}
        </section>

        <!-- Areas of Interest -->
        <section class="card">
            <h2>Aree di Interesse</h2>
            {% if aree_interesse_list %}
            <ul>
                {% for area in aree_interesse_list %}
                <li>{{ area.strip() }}</li>
                {% endfor %}
            </ul>
            {% else %}
            <p style="color:#888;">Nessuna area di interesse specificata. Modifica il profilo per aggiungerne.</p>
            {% endif %}
        </section>
        
        <!-- Reviews Section -->
        <section class="card">
            <h2>Recensioni</h2>
            <p style="color:#888;">Nessuna recensione disponibile al momento.</p>
        </section>

    </main>

    <!-- Sidebar -->
    <aside class="sidebar">
        <!-- Stats Card -->
        <section class="consultation-card">
            <h2>Le tue Statistiche</h2>
            
            <div class="stat-item">
                <div class="stat-label">Bollini</div>
                <div class="stat-value">{{ user.bollini }}</div>
            </div>
            
            <div class="stat-item">
                <div class="stat-label">Consulenze Acquistate</div>
                <div class="stat-value">{{ user.consulenze_acquistate }}</div>
            </div>
            
            <div class="stat-item">
                <div class="stat-label">Consulenze Vendute</div>
                <div class="stat-value">{{ user.consulenze_vendute }}</div>
            </div>

            <a href="/availability" class="btn btn-primary">
                <i class="fas fa-calendar-alt"></i> Gestisci Disponibilit√†
            </a>
        </section>
        
        <!-- Account Info -->
        <section class="card">
            <h3>Account</h3>
            <div class="account-info">
                <p><strong>Email:</strong><br>{{ user.email }}</p>
                <p><strong>Status:</strong><br>
                    {% if user.confirmed == 1 %}
                    <span style="color:#28a745;">‚úì Verificato</span>
                    {% else %}
                    <span style="color:#dc3545;">Non Verificato</span>
                    {% endif %}
                </p>
                <p><strong>Membro dal:</strong><br>{{ user.created_at[:10] if user.created_at else 'N/A' }}</p>
            </div>
            <a href="/reset-password" class="btn btn-secondary">Cambia Password</a>
        </section>
    </aside>
</div>

<!-- üî• Modal per crop immagine -->
<div id="cropModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2>Ritaglia l'immagine</h2>
        <div class="crop-container">
            <img id="imageToCrop" style="max-width: 100%;">
        </div>
        <div class="modal-actions" style="margin-top: 20px;">
            <button id="cancelCrop" class="btn btn-secondary">Annulla</button>
            <button id="saveCrop" class="btn btn-primary">Salva</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
<script>
    // ========== EDIT PROFILE FUNCTIONALITY ==========
    const editBtn = document.getElementById('editProfileBtn');
    const cancelBtn = document.getElementById('cancelEditBtn');
    const editSection = document.getElementById('editSection');
    const viewSection = document.getElementById('viewSection');
    const profileForm = document.getElementById('profileForm');

    editBtn.addEventListener('click', () => {
        editSection.style.display = 'block';
        if(viewSection) viewSection.style.display = 'none';
        window.scrollTo({ top: editSection.offsetTop - 80, behavior: 'smooth' });
    });

    cancelBtn.addEventListener('click', () => {
        editSection.style.display = 'none';
        if(viewSection) viewSection.style.display = 'block';
    });

    profileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const successDiv = document.getElementById('successMessage');
        const errorDiv = document.getElementById('errorMessage');
        successDiv.style.display = 'none';
        errorDiv.style.display = 'none';
        
        const formData = new FormData(profileForm);
        const params = new URLSearchParams(formData);
        
        console.log('Dati inviati:', Object.fromEntries(params));
        
        try {
            const response = await fetch('/api/profile/update', {
                method: 'POST',
                body: params
            });
            
            const data = await response.json();
            
            if (response.ok) {
                let message = 'Profilo aggiornato con successo!';
                
                // Check if verification was requested
                if (data.verification_requested) {
                    message += ' ‚ú® Il tuo profilo √® stato inviato per la verifica. Riceverai una notifica quando sar√† approvato.';
                }
                
                successDiv.textContent = message;
                successDiv.style.display = 'block';
                setTimeout(() => {
                    window.location.reload();
                }, 2500);
            } else {
                errorDiv.textContent = data.error || 'Errore durante l\'aggiornamento';
                errorDiv.style.display = 'block';
            }
        } catch (error) {
            errorDiv.textContent = 'Errore di connessione';
            errorDiv.style.display = 'block';
            console.error('Error:', error);
        }
    });

    // ========== PROFILE PICTURE UPLOAD & CROP ==========
    let cropperInstance = null;

    const profilePictureInput = document.getElementById('profilePictureInput');
    const cropModal = document.getElementById('cropModal');
    const imageToCrop = document.getElementById('imageToCrop');
    const saveCropBtn = document.getElementById('saveCrop');
    const cancelCropBtn = document.getElementById('cancelCrop');
    const closeModalBtn = document.querySelector('.close-modal');

    profilePictureInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        console.log('File selezionato:', file.name);
        
        const reader = new FileReader();
        reader.onload = (event) => {
            imageToCrop.src = event.target.result;
            cropModal.style.display = 'flex';
            document.body.classList.add('modal-open');
            
            console.log('Modal aperto');
            
            if (cropperInstance) {
                cropperInstance.destroy();
            }
            
            setTimeout(() => {
                cropperInstance = new Cropper(imageToCrop, {
                    aspectRatio: 1,
                    viewMode: 1,
                    autoCropArea: 0.8,
                    responsive: true,
                    restore: false,
                    guides: true,
                    center: true,
                    highlight: true,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    background: false,
                    movable: true,
                    zoomable: true,
                    scalable: true,
                });
                console.log('Cropper inizializzato');
            }, 150);
        };
        reader.readAsDataURL(file);
    });

    saveCropBtn.addEventListener('click', async () => {
        console.log('Salvataggio crop...');
        
        const canvas = cropperInstance.getCroppedCanvas({
            width: 400,
            height: 400,
        });
        
        canvas.toBlob(async (blob) => {
            const formData = new FormData();
            formData.append('file', blob, 'profile.jpg');
            
            console.log('Uploading...');
            
            try {
                const response = await fetch('/api/upload-profile-picture', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                console.log('Response:', data);
                
                if (response.ok) {
                    const profileImage = document.getElementById('profileImage');
                    if (profileImage.tagName === 'DIV') {
                        const img = document.createElement('img');
                        img.src = data.url + '?t=' + Date.now();
                        img.alt = 'Profile';
                        img.className = 'profile-avatar-large';
                        img.id = 'profileImage';
                        profileImage.replaceWith(img);
                    } else {
                        profileImage.src = data.url + '?t=' + Date.now();
                    }
                    
                    cropModal.style.display = 'none';
                    cropperInstance.destroy();
                    cropperInstance = null;
                    alert('Immagine caricata con successo!');
                } else {
                    alert(data.error || 'Errore durante l\'upload');
                }
            } catch (error) {
                alert('Errore di connessione');
                console.error(error);
            }
        }, 'image/jpeg', 0.9);
    });

    function closeCropModal() {
        cropModal.style.display = 'none';
        document.body.classList.remove('modal-open');
        if (cropperInstance) {
            cropperInstance.destroy();
            cropperInstance = null;
        }
        profilePictureInput.value = '';
    }

    cancelCropBtn.addEventListener('click', closeCropModal);
    closeModalBtn.addEventListener('click', closeCropModal);

    // Character counter for descrizione textarea
    const descrizioneTextarea = document.getElementById('descrizioneTextarea');
    const charCounter = document.getElementById('charCounter');
    const descrizioneHint = document.getElementById('descrizioneHint');

    function updateCharCounter() {
        const length = descrizioneTextarea.value.length;
        charCounter.textContent = `${length}/200 caratteri`;
        
        if (length >= 200) {
            charCounter.style.color = '#28a745';
            descrizioneHint.style.color = '#28a745';
            descrizioneHint.textContent = '‚úì La descrizione soddisfa i requisiti per la verifica del profilo.';
        } else {
            charCounter.style.color = '#dc3545';
            descrizioneHint.style.color = '#dc3545';
            descrizioneHint.textContent = `La descrizione deve essere di almeno 200 caratteri per richiedere la verifica del profilo. (ne mancano ${200 - length})`;
        }
    }

    if (descrizioneTextarea) {
        // Initial count on page load
        updateCharCounter();
        
        // Update on input
        descrizioneTextarea.addEventListener('input', updateCharCounter);
    }

    // ========== UPCOMING APPOINTMENTS ==========
    async function loadUpcomingAppointments() {
        try {
            const response = await fetch('/api/booking/upcoming');
            if (!response.ok) return;
            
            const data = await response.json();
            const bookings = data.bookings || [];
            
            const section = document.getElementById('upcomingAppointmentsSection');
            const placeholder = document.getElementById('coverImagePlaceholder');
            
            if (bookings.length === 0) {
                // Nessun appuntamento, mostra solo il banner
                return;
            }
            
            // Crea il banner con gli appuntamenti
            const appointmentsHTML = `
                <div class="upcoming-appointments">
                    <h3><i class="fas fa-calendar-check"></i> Prossimi Appuntamenti</h3>
                    <div class="appointments-list">
                        ${bookings.map(booking => createAppointmentCard(booking)).join('')}
                    </div>
                </div>
            `;
            
            section.innerHTML = appointmentsHTML;
            
            // Aggiungi event listeners
            bookings.forEach(booking => {
                setupAppointmentActions(booking);
            });
            
            // Aggiorna ogni minuto
            setTimeout(loadUpcomingAppointments, 60000);
            
        } catch (error) {
            console.error('Error loading appointments:', error);
        }
    }
    
    function createAppointmentCard(booking) {
        console.log('Booking data:', booking);
        
        const otherUser = booking.other_user;
        const avatarHTML = otherUser.picture 
            ? `<img src="${otherUser.picture}" alt="${otherUser.name}" class="appointment-avatar">`
            : `<div class="appointment-avatar-placeholder">üë§</div>`;
        
        // Parse date correttamente (booking.date pu√≤ essere "YYYY-MM-DD" o "YYYY-MM-DD HH:MM:SS")
        let date;
        try {
            // Estrai solo la parte della data (prima dello spazio se presente)
            const datePart = booking.date.split(' ')[0];
            const [year, month, day] = datePart.split('-').map(Number);
            const [hours, minutes] = booking.start_time.split(':').map(Number);
            date = new Date(year, month - 1, day, hours, minutes);
            console.log('Parsed date:', date, 'from:', booking.date);
        } catch (e) {
            console.error('Error parsing date:', e, booking.date, booking.start_time);
            date = new Date();
        }
        
        const dateStr = date.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' });
        
        const roleLabel = booking.role === 'client' ? 'Consulenza con' : 'Consulenza richiesta da';
        
        // Calcola il tempo rimanente lato client (pi√π accurato per il timezone)
        const now = new Date();
        const timeUntilMs = date - now;
        const timeUntilMinutes = Math.floor(timeUntilMs / (1000 * 60));
        
        console.log('Time until minutes (client-side):', timeUntilMinutes, 'Server said:', booking.time_until_minutes);
        
        let actionsHTML = '';
        let statusHTML = '';
        
        // Usa il calcolo client-side invece di quello del server
        const minutesUntil = Math.abs(timeUntilMinutes);
        
        if (timeUntilMinutes > 10) {
            // Troppo presto
            const hours = Math.floor(minutesUntil / 60);
            const mins = minutesUntil % 60;
            let timeText = '';
            if (hours > 0) {
                timeText = `${hours}h ${mins}min`;
            } else {
                timeText = `${mins}min`;
            }
            statusHTML = `<div class="time-until"><i class="fas fa-clock"></i> Inizia tra ${timeText}</div>`;
        } else if (timeUntilMinutes <= 10 && timeUntilMinutes >= -10) {
            // Pu√≤ joinare: da 10 minuti prima fino a 10 minuti dopo l'inizio
            if (booking.can_start_call) {
                // Entrambi hanno joinato - mostra "Inizia Call"
                actionsHTML = `
                    <button class="btn-start-call" onclick="startCall(${booking.id})">
                        <i class="fas fa-video"></i> Inizia Call
                    </button>
                `;
            } else if (booking.has_joined) {
                // L'utente ha joinato, aspetta l'altro
                statusHTML = `<div class="waiting-indicator"><i class="fas fa-hourglass-half"></i> In attesa dell'altro partecipante...</div>`;
                actionsHTML = `<button class="btn-join" disabled><i class="fas fa-check"></i> Pronto</button>`;
            } else {
                // L'utente non ha ancora joinato
                actionsHTML = `
                    <button class="btn-join" onclick="joinAppointment(${booking.id})" id="join-btn-${booking.id}">
                        <i class="fas fa-sign-in-alt"></i> Partecipa
                    </button>
                `;
                if (booking.other_joined) {
                    statusHTML = `<div class="waiting-indicator"><i class="fas fa-user-check"></i> ${otherUser.name} √® pronto</div>`;
                }
            }
        } else if (timeUntilMinutes < -10) {
            // Sono passati pi√π di 10 minuti dall'inizio
            if (booking.has_joined && !booking.other_joined) {
                // L'utente ha partecipato ma l'altro no - mostra messaggio di assenza
                const whoMissed = booking.role === 'client' ? 'il consulente' : 'il cliente';
                statusHTML = `
                    <div class="appointment-missed">
                        <i class="fas fa-times-circle"></i>
                        <p>Siamo spiacenti ma ${whoMissed} non ha partecipato alla call programmata.</p>
                    </div>
                `;
            } else if (!booking.has_joined && booking.other_joined) {
                // L'utente non ha partecipato ma l'altro s√¨
                statusHTML = `
                    <div class="appointment-missed">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Non hai partecipato a questa consulenza.</p>
                    </div>
                `;
            } else if (!booking.has_joined && !booking.other_joined) {
                // Nessuno dei due ha partecipato
                statusHTML = `
                    <div class="appointment-missed">
                        <i class="fas fa-ban"></i>
                        <p>Questa consulenza non si √® svolta.</p>
                    </div>
                `;
            }
        }
        
        return `
            <div class="appointment-card" id="appointment-${booking.id}">
                <div class="appointment-header">
                    ${avatarHTML}
                    <div class="appointment-info">
                        <h4>${otherUser.name}</h4>
                        <p>${roleLabel}</p>
                    </div>
                </div>
                <div class="appointment-details">
                    <div class="appointment-detail">
                        <i class="fas fa-calendar"></i>
                        <span>${dateStr}</span>
                    </div>
                </div>
                <div class="appointment-details">
                    <div class="appointment-detail">
                        <i class="fas fa-clock"></i>
                        <span>${booking.start_time}</span>
                    </div>
                    <div class="appointment-detail">
                        <i class="fas fa-hourglass-half"></i>
                        <span>${booking.duration} min</span>
                    </div>
                </div>
                ${statusHTML}
                <div class="appointment-actions">
                    ${actionsHTML}
                </div>
            </div>
        `;
    }
    
    function setupAppointmentActions(booking) {
        // Event listeners gi√† gestiti tramite onclick inline per semplicit√†
    }
    
    async function joinAppointment(bookingId) {
        const btn = document.getElementById(`join-btn-${bookingId}`);
        if (!btn) return;
        
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connessione...';
        
        try {
            const response = await fetch(`/api/booking/${bookingId}/join`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            if (response.ok) {
                const data = await response.json();
                
                if (data.can_start_call) {
                    // Entrambi hanno joinato - mostra "Inizia Call"
                    loadUpcomingAppointments();
                } else {
                    // In attesa dell'altro
                    btn.innerHTML = '<i class="fas fa-check"></i> Pronto';
                    const card = document.getElementById(`appointment-${bookingId}`);
                    const actions = card.querySelector('.appointment-actions');
                    actions.insertAdjacentHTML('beforebegin', 
                        '<div class="waiting-indicator"><i class="fas fa-hourglass-half"></i> In attesa dell\'altro partecipante...</div>'
                    );
                }
            } else {
                alert('Errore durante la connessione');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Partecipa';
            }
        } catch (error) {
            console.error('Error joining appointment:', error);
            alert('Errore di connessione');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Partecipa';
        }
    }
    
    function startCall(bookingId) {
        window.location.href = `/booking/call/${bookingId}`;
    }
    
    // Carica gli appuntamenti all'avvio
    loadUpcomingAppointments();

</script>
{% endblock %}