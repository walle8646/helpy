{% extends "base.html" %}

{% block title %}Consulenti - Helpy{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/consultants.css">
{% endblock %}

{% block content %}
    <!-- Hero Section con Ricerca -->
    <section class="search-hero">
        <div class="search-container">
            <h1>Non sei solo: trova chi c'√® gi√† passato e pu√≤ aiutarti ora</h1>
            <form class="search-form" method="GET" action="/consultants">
                <input 
                    type="text" 
                    name="search" 
                    placeholder="üîç Cerca: finanziamenti, cambio lavoro, vendere online..."
                    value="{{ search_query }}"
                    class="search-input"
                >
                <button type="submit" class="search-btn">Cerca</button>
            </form>
            
            <!-- üî• Suggerimenti ricerca rapida -->
            <div class="search-suggestions">
                <span class="suggestion-label">Ricerche popolari:</span>
                <a href="/consultants?search=finanziamenti" class="search-tag">üí∞ Finanziamenti</a>
                <a href="/consultants?search=cambio lavoro" class="search-tag">üëî Cambio Lavoro</a>
                <a href="/consultants?search=social media" class="search-tag">üì± Social Media</a>
                <a href="/consultants?search=startup" class="search-tag">üöÄ Startup</a>
                <a href="/consultants?search=investimenti" class="search-tag">üìà Investimenti</a>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <div class="consultants-container">
        <!-- Sidebar Filtri -->
        <aside class="filters-sidebar">
            <h3>Categorie</h3>
            <ul class="category-filters">
                <li>
                    <a href="/consultants" class="{% if not selected_category %}active{% endif %}">
                        Tutte le categorie
                    </a>
                </li>
                {% for cat in categories %}
                <li>
                    <a href="/consultants?category={{ cat.id }}{% if min_price %}&min_price={{ min_price }}{% endif %}{% if max_price %}&max_price={{ max_price }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}" 
                       class="{% if selected_category == cat.id %}active{% endif %}"
                       style="border-left: 4px solid {{ cat.color }};">
                        <span class="category-icon">{{ cat.icon }}</span>
                        {{ cat.name }}
                    </a>
                </li>
                {% endfor %}
            </ul>

            <!-- üî• FILTRO RANGE PREZZO -->
            <div class="additional-filters">
                <h4>Range Prezzo (‚Ç¨/ora)</h4>
                <form id="priceFilterForm" class="price-filter-form">
                    <div class="price-inputs-vertical">
                        <div class="price-input-wrapper">
                            <span class="currency-symbol">‚Ç¨</span>
                            <input 
                                type="number" 
                                name="min_price" 
                                id="minPrice"
                                placeholder="Prezzo minimo" 
                                min="0"
                                value="{{ min_price or '' }}"
                                class="price-input"
                            >
                        </div>
                        <div class="price-input-wrapper">
                            <span class="currency-symbol">‚Ç¨</span>
                            <input 
                                type="number" 
                                name="max_price" 
                                id="maxPrice"
                                placeholder="Prezzo massimo" 
                                min="0"
                                value="{{ max_price or '' }}"
                                class="price-input"
                            >
                        </div>
                    </div>
                    <button type="submit" class="btn-apply-price" id="applyPriceBtn" disabled>Applica Filtro</button>
                    {% if min_price or max_price %}
                    <a href="/consultants{% if selected_category %}?category={{ selected_category }}{% endif %}{% if search_query %}{% if selected_category %}&{% else %}?{% endif %}search={{ search_query }}{% endif %}" class="btn-reset-price">‚úï Reset Prezzo</a>
                    {% endif %}
                </form>
                
                <div class="price-suggestions">
                    <a href="/consultants?min_price=10&max_price=50{% if selected_category %}&category={{ selected_category }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}" class="price-tag">‚Ç¨ 10-50</a>
                    <a href="/consultants?min_price=50&max_price=100{% if selected_category %}&category={{ selected_category }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}" class="price-tag">‚Ç¨‚Ç¨ 50-100</a>
                    <a href="/consultants?min_price=100{% if selected_category %}&category={{ selected_category }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}" class="price-tag">‚Ç¨‚Ç¨‚Ç¨ 100+</a>
                </div>
            </div>
        </aside>

        <!-- Griglia Consulenti -->
        <main class="consultants-main">
            <div class="results-header">
                <p>{{ total_count }} consulenti trovati</p>
            </div>

            <div class="consultants-grid">
                {% for item in consultants %}
                <div class="consultant-card">
                    <a href="/user/{{ item.id }}" class="card-link">
                        <!-- Avatar -->
                        {% if item.profile_picture %}
                        <img src="{{ item.profile_picture }}" alt="{{ item.nome }}" class="consultant-avatar">
                        {% else %}
                        <div class="consultant-avatar-default">
                            {{ item.category.icon if item.category else 'üë§' }}
                        </div>
                        {% endif %}

                        <!-- Info -->
                        <h3>{{ item.nome }} {{ item.cognome or '' }}</h3>
                        <p class="profession">{{ item.professione or 'Consulente' }}</p>

                        <!-- Categoria -->
                        {% if item.category %}
                        <span class="category-badge" style="background: {{ item.category.color }}20; color: {{ item.category.color }};">
                            {{ item.category.icon }} {{ item.category.name }}
                        </span>
                        {% endif %}

                        <!-- Stats -->
                        <div class="consultant-stats">
                            <span class="rating">‚≠ê {{ item.bollini }}</span>
                            <span class="reviews">{{ item.consulenze_vendute }} recensioni</span>
                        </div>

                        <!-- Prezzo -->
                        {% if item.prezzo_consulenza %}
                        <div class="price">A partire da: <strong>‚Ç¨{{ item.prezzo_consulenza }}</strong></div>
                        {% endif %}
                    </a>

                    <button class="btn-consult">Richiedi consulenza</button>
                </div>
                {% endfor %}
            </div>

            <!-- Paginazione -->
            {% if total_pages > 1 %}
            <div class="pagination">
                {% if current_page > 1 %}
                <a href="/consultants?page={{ current_page - 1 }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if min_price %}&min_price={{ min_price }}{% endif %}{% if max_price %}&max_price={{ max_price }}{% endif %}" class="page-btn">‚Üê Precedente</a>
                {% endif %}

                {% for p in range(1, total_pages + 1) %}
                    {% if p == current_page %}
                    <span class="page-number active">{{ p }}</span>
                    {% else %}
                    <a href="/consultants?page={{ p }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if min_price %}&min_price={{ min_price }}{% endif %}{% if max_price %}&max_price={{ max_price }}{% endif %}" class="page-number">{{ p }}</a>
                    {% endif %}
                {% endfor %}

                {% if current_page < total_pages %}
                <a href="/consultants?page={{ current_page + 1 }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if min_price %}&min_price={{ min_price }}{% endif %}{% if max_price %}&max_price={{ max_price }}{% endif %}" class="page-btn">Successiva ‚Üí</a>
                {% endif %}
            </div>
            {% endif %}
        </main>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    // üî• Filtro Prezzo Dinamico
    const minPriceInput = document.getElementById('minPrice');
    const maxPriceInput = document.getElementById('maxPrice');
    const applyBtn = document.getElementById('applyPriceBtn');
    const priceForm = document.getElementById('priceFilterForm');

    function checkPriceInputs() {
        const minValue = minPriceInput.value.trim();
        const maxValue = maxPriceInput.value.trim();
        
        // Converti in numeri
        const minNum = parseInt(minValue) || 0;
        const maxNum = parseInt(maxValue) || 0;
        
        // Abilita se almeno uno dei due √® >= 10
        const isValid = minNum >= 10 || maxNum >= 10;
        
        applyBtn.disabled = !isValid;
        
        console.log('Min:', minNum, 'Max:', maxNum, 'Valid:', isValid); // Debug
    }

    minPriceInput.addEventListener('input', checkPriceInputs);
    maxPriceInput.addEventListener('input', checkPriceInputs);

    priceForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const minPrice = minPriceInput.value.trim();
        const maxPrice = maxPriceInput.value.trim();
        
        console.log('Submit - Min:', minPrice, 'Max:', maxPrice); // Debug
        
        // Costruisci URL mantenendo i filtri esistenti
        const params = new URLSearchParams();
        
        // Mantieni categoria e ricerca se presenti
        const urlParams = new URLSearchParams(window.location.search);
        const category = urlParams.get('category');
        const search = urlParams.get('search');
        
        if (category) {
            params.append('category', category);
        }
        
        if (search) {
            params.append('search', search);
        }
        
        // Aggiungi prezzi se validi (>= 10)
        const minNum = parseInt(minPrice);
        const maxNum = parseInt(maxPrice);
        
        if (!isNaN(minNum) && minNum >= 10) {
            params.append('min_price', minNum);
        }
        
        if (!isNaN(maxNum) && maxNum >= 10) {
            params.append('max_price', maxNum);
        }
        
        console.log('URL finale:', '/consultants?' + params.toString()); // Debug
        
        // Redirect con nuovi parametri
        window.location.href = '/consultants?' + params.toString();
    });

    // Check iniziale
    checkPriceInputs();
</script>
{% endblock %}